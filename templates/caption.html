<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script> 
    <title>CaptionAI | SubSync</title>
</head>
<style>
    body {
        background-color: black;
        color: white;
        font-family: 'Open Sans', sans-serif;
    }
    .head h1 {
        text-align: center;
        font-size: 59px;
        font-family: 'Open Sans', sans-serif;
        position: relative;
        background-image: linear-gradient(to right, rgba(255, 255, 255, 0.2) 0%, white 25%, rgba(255, 255, 255, 0.2) 50%, white 75%, rgba(255, 255, 255, 0.2) 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        color: transparent;
        background-size: 200% 100%;
        animation: liveTextGradient 3s linear 1 forwards;
    }
    @keyframes liveTextGradient {
        0% { background-position: 100% 0; }
        100% { background-position: 0% 0; }
    }
    nav {
        color: white;
    }
    .file-input-container {
        max-width: 500px;
        margin: 30px auto;
        padding: 20px;
        background-color: #1a1a1a;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    .file-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #333;
        border-radius: 5px;
        background-color: #2a2a2a;
        color: white;
    }
    /* --- UPDATED LIQUID GLASS & ROUNDED BUTTONS --- */
    .process-button {
        padding: 10px 20px;
        /* Liquid Glass BG: Semi-transparent white with blur */
        background-color: rgba(255, 255, 255, 0.15); 
        backdrop-filter: blur(5px);
        color: white; /* Change text color to white for contrast */
        border: 1px solid rgba(255, 255, 255, 0.3); /* Subtle white border */
        border-radius: 50px; /* Highly rounded corners */
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s ease; 
        display: flex;
        align-items: center;
        justify-content: center; /* Center content in button */
        gap: 8px;
    }
    .process-button:hover:not(:disabled) {
        background-color: rgba(255, 255, 255, 0.3); /* Brighter on hover */
    }
    .process-button:disabled {
        background-color: rgba(255, 255, 255, 0.05); /* Very faint on disabled */
        backdrop-filter: none; 
        border-color: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        color: #aaa;
    }
    /* NEW: Study Mode Button Specific Style */
    .study-button {
        background-color: rgba(70, 130, 180, 0.2);
        border: 1px solid #4682b4;
        color: #4682b4;
    }
    .study-button:hover:not(:disabled) {
        background-color: rgba(70, 130, 180, 0.35);
        color: white;
    }
    /* ----------------------------------------------- */
    .head p {
        text-align: center;
        color: #949495;
        position: relative;
        z-index: 3;
    }
    /* Result Area Styles */
    #media-player-area {
        margin-top: 40px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        display: none;
        opacity: 0;
        transition: opacity 1s ease-in-out;
    }
    #media-player {
        width: 100%;
        max-height: 450px;
        background-color: black;
        border-radius: 8px;
    }
    /* --- UPDATED LIQUID GLASS FOR TRANSCRIPT AREA --- */
    #transcript-area {
        margin-top: 20px;
        padding: 20px;
        /* Liquid Glass Effect */
        background-color: rgba(26, 26, 26, 0.5); /* Semi-transparent #1a1a1a */
        backdrop-filter: blur(10px); 
        border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border for definition */
        border-radius: 8px;
        text-align: left;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        display: none;
        opacity: 0;
        transition: opacity 1s ease-in-out;
    }
    /* ----------------------------------------------- */
    
    #transcript-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    #transcript-area h3 {
        color: #fff;
        margin-bottom: 0; 
    }

    /* Group for Analyze/Download buttons */
    #action-buttons {
        display: flex;
        gap: 10px; 
    }

    /* --- UPDATED LIQUID GLASS & ROUNDED FOR ANALYZE/DOWNLOAD BUTTONS --- */
    .analyze-button {
        padding: 8px 15px;
        background-color: rgba(0, 255, 115, 0.2); /* Liquid Glass: Neon green tint */
        backdrop-filter: blur(5px);
        color: #00ff73; /* Keep text color neon green for analyze */
        border: 1px solid #00ff73; /* Add border for definition */
        border-radius: 50px; /* Highly rounded corners */
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease; 
    }
    .analyze-button:hover {
        background-color: rgba(0, 255, 115, 0.35); /* Brighter neon green tint on hover */
    }

    .download-button {
        padding: 8px 15px;
        background-color: rgba(70, 130, 180, 0.2); /* Liquid Glass: Steel blue tint */
        backdrop-filter: blur(5px);
        color: #4682b4; /* Keep text color steel blue for download/save */
        border: 1px solid #4682b4; /* Add border for definition */
        border-radius: 50px; /* Highly rounded corners */
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .download-button:hover {
        background-color: rgba(70, 130, 180, 0.35); /* Brighter steel blue tint on hover */
    }
    .download-button:disabled, .analyze-button:disabled {
        background-color: rgba(255, 255, 255, 0.05); /* Very faint on disabled */
        backdrop-filter: none;
        border-color: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        color: #aaa;
    }
    /* NEW: Semantic Search Button Style - Using a different color for distinction */
    .search-button {
        padding: 8px 15px;
        background-color: rgba(255, 165, 0, 0.2); /* Liquid Glass: Orange tint */
        backdrop-filter: blur(5px);
        color: #ffa500; /* Orange text color */
        border: 1px solid #ffa500; /* Orange border */
        border-radius: 50px; /* Highly rounded corners */
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .search-button:hover {
        background-color: rgba(255, 165, 0, 0.35); /* Brighter orange tint on hover */
    }
    .search-button:disabled {
        background-color: rgba(255, 255, 255, 0.05); /* Very faint on disabled */
        backdrop-filter: none;
        border-color: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        color: #aaa;
    }
    /* NEW: Cognitive Map Button Style (Using a purple/magenta tint) */
    .map-button {
        padding: 8px 15px;
        background-color: rgba(138, 43, 226, 0.2); /* Liquid Glass: BlueViolet tint */
        backdrop-filter: blur(5px);
        color: #8a2be2; /* BlueViolet text color */
        border: 1px solid #8a2be2; /* BlueViolet border */
        border-radius: 50px; /* Highly rounded corners */
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .map-button:hover:not(:disabled) {
        background-color: rgba(138, 43, 226, 0.35); /* Brighter tint on hover */
        color: white;
    }
    .map-button:disabled {
        background-color: rgba(255, 255, 255, 0.05);
        backdrop-filter: none;
        border-color: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        color: #aaa;
    }
    /* ----------------------------------------------- */
    
    /* NEW: Modal styles (Copying emotion modal base styles) */
    .emotion-modal-content, .search-modal-content {
        background-color: rgba(26, 26, 26, 0.7); /* Semi-transparent */
        backdrop-filter: blur(15px);
        color: white;
        border: 1px solid rgba(0, 255, 115, 0.5); /* Semi-transparent border */
        border-radius: 15px; /* Slightly more rounded */
    }
    .emotion-modal-header, .emotion-modal-footer, .search-modal-header, .search-modal-footer {
        border-bottom: none;
        border-top: none;
    }
    .emotion-modal-title {
        color: #00ff73;
    }
    .search-modal-title {
        color: #ffa500; /* Orange title for search modal */
    }
    #emotionChartContainer {
        height: 300px;
        width: 100%;
        margin-top: 15px;
    }

    /* Transcript Content Styles for synchronization and EMOTION COLORING */
    #transcript-content {
        color: #e0e0e0; /* Slightly lesser tone of white */
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 1.1em;
        line-height: 1.8;
    }
    .time-segment {
        cursor: pointer;
        transition: color 0.1s;
        display: block; 
        margin-bottom: 8px; 
        color: #e0e0e0; /* Slightly lesser tone of white */
    }
    .time-segment:hover {
        color: #fff;
    }
    .highlighted-segment {
        color: white !important; /* White highlight */
        font-weight: bold;
        transition: color 0.1s;
    }
    
    /* --- EMOTION COLORS --- */
    .emotion-LOVE { color: #ff69b4; }    
    .emotion-SURPRISE { color: #ffff00; } 
    .emotion-FEAR { color: #800080; }   
    .emotion-JOY { color: #ffa500; }    
    .emotion-SADNESS { color: #4682b4; } 
    .emotion-ANGER { color: #ff0000; }  
    .emotion-NEUTRAL { color: #e0e0e0; }
    /* --- END EMOTION COLORS --- */

    .time-segment strong {
        color: #00ff73; /* Speaker label color (Kept green for speaker identification) */
        margin-right: 5px;
    }
    
    #loading-indicator {
        text-align: center;
        margin-top: 20px;
        display: none;
        color: #949495;
    }
    #file-error-message {
        color: #ff5555;
        display: none;
        margin-top: -10px;
    }
    
    /* NEW: Tag Style */
    .tag {
        background-color: rgba(70, 130, 180, 0.5); /* Blue-tinted liquid glass for tags */
        backdrop-filter: blur(3px);
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
    }
    /* Semantic Search Results Styling */
    .search-result-item {
        background-color: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .search-result-item:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    .search-result-item .result-timestamp {
        font-weight: bold;
        color: #ffa500; /* Orange for search timestamp */
        margin-right: 10px;
    }

/* ----------------- START: IDRAK ADDITIONS (do not remove) ----------------- */

    /* Idrak button (fixed bottom-left) - liquid glass matching look */
    #idrak-button {
        position: fixed;
        left: 18px;
        bottom: 18px;
        z-index: 2000;
        padding: 12px 14px;
        border-radius: 14px;
        background-color: rgba(255,255,255,0.08);
        backdrop-filter: blur(6px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        border: 1px solid rgba(255,255,255,0.08);
        color: white;
        cursor: pointer;
        display: flex;
        gap: 8px;
        align-items: center;
        font-weight: 700;
        letter-spacing: 0.2px;
    }
    #idrak-button .dot {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        background: linear-gradient(45deg,#00ff73,#8a2be2);
        box-shadow: 0 0 8px rgba(138,43,226,0.35);
    }

    /* Idrak Chat modal specifics */
    .idrak-modal-content {
        background-color: rgba(12,12,12,0.92);
        color: white;
        border-radius: 12px;
        border: 1px solid rgba(0,255,115,0.12);
    }
    .idrak-chat-window {
        max-height: 60vh;
        overflow-y: auto;
        padding: 12px;
        border-radius: 8px;
        background-color: rgba(20,20,20,0.6);
        border: 1px solid rgba(255,255,255,0.03);
    }
    .idrak-message {
        margin-bottom: 10px;
        display: flex;
        gap: 8px;
    }
    .idrak-message.user .bubble {
        margin-left: auto;
        background-color: rgba(0,255,115,0.08);
        border: 1px solid rgba(0,255,115,0.12);
        color: #eafff1;
    }
    .idrak-message.ai .bubble {
        margin-right: auto;
        background-color: rgba(138,43,226,0.06);
        border: 1px solid rgba(138,43,226,0.12);
        color: #f0e9ff;
    }
    .idrak-message .bubble {
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 78%;
        font-size: 0.95em;
        line-height: 1.35;
        white-space: pre-wrap;
        word-break: break-word;
    }
    .idrak-controls {
        display:flex;
        gap:8px;
        align-items:center;
        margin-top:10px;
    }
    .idrak-small {
        font-size: 0.85em;
        color: #cfcfcf;
    }
    .idrak-timestamp-btn {
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.06);
        background-color: rgba(255,255,255,0.02);
        cursor: pointer;
    }

/* ----------------- END: IDRAK ADDITIONS ----------------- */

</style>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="/home" style="color:white;">SubSync</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" aria-current="page" href="/home" style="color:white;">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/caption-ai" style="color:rgb(146, 144, 144);">CaptionAI</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/notes" style="color:rgb(146, 144, 144);">Notes</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/logout" style="color:rgb(146, 144, 144);">Logout</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

    <br><br><br><br><br>
    <div class="head">
        <h1>Transcribe and Synchronize.</h1>
        <p>Upload an audio or video file to generate a time-synchronized transcript with Speaker Diarization and Emotion Analysis.</p>
        <br><br>
        
        <div class="file-input-container">
            <input type="file" id="audioFileInput" class="file-input" accept="audio/*,video/*">
            <p id="file-error-message">Please select a file.</p>
            
            <div style="display: flex; gap: 15px; width: 100%;">
                <button id="captionModeButton" class="process-button" onclick="uploadAndProcessAudio(true)" style="flex: 1;" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-play-btn" viewBox="0 0 16 16">
                        <path d="M6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814z"/>
                        <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 0a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1z"/>
                    </svg>
                    Caption Mode
                </button>
                <button id="studyModeButton" class="process-button study-button" onclick="processStudyMode()" style="flex: 1;" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-book" viewBox="0 0 16 16">
                        <path d="M1 2.828c.885-.37 2.154-.71 3.384-.943.58-.112 1.026-.234 1.258-.334.31-.132.583-.295.787-.456.237-.189.288-.27.348-.37.264-.474.34-.78.34-.78C11.5 2.15 11.5 8.1 11.5 8.1c0 .47-.282.686-.443.892-.294.37-.53.567-.797.749-.234.156-.498.318-.737.491-.255.187-.468.36-.61.479-.11.088-.25.203-.393.303-.456.326-.89.577-1.428.847-.393.197-.83.33-.872.348v-.386c.042-.018.479-.151.872-.348.538-.27.972-.52 1.428-.847.143-.1.283-.215.393-.303.142-.119.355-.292.61-.479.239-.173.503-.335.737-.491.267-.182.503-.38.797-.748.16-.206.443-.422.443-.893 0 0 0-5.95 0-5.95 0-.094-.038-.178-.052-.224-.048-.158-.135-.29-.27-.41-.127-.116-.299-.24-.523-.342-.232-.1-.678-.222-1.258-.334-1.23-.233-2.5-.573-3.384-.943v6.52c0 .248-.1.488-.28.66-.18.17-.42.26-.66.26h6.8c.24 0 .48-.09.66-.26.18-.17.28-.412.28-.66V8.1c0 0-.001-5.95 0-5.95.06.1.11.181.348.37.204.16.477.324.787.456.232.1.678.222 1.258.334 1.23.233 2.5.573 3.384.943v6.52c0 .248-.1.488-.28.66-.18.17-.42.26-.66.26H3.94c-.24 0-.48-.09-.66-.26-.18-.17-.28-.412-.28-.66V2.828zM4.094 8.1c0 0 0 0 0 0v6.52c0 .248-.1.488-.28.66-.18.17-.42.26-.66.26H3.94c-.24 0-.48-.09-.66-.26-.18-.17-.28-.412-.28-.66V8.1c0 0 0 0 0 0z"/>
                    </svg>
                    Study Mode
                </button>
            </div>
        </div>
        
        <div id="loading-indicator">Processing your media...</div>
        
        <div id="media-player-area">
            <video id="media-player" controls preload="metadata"></video>
        </div>

        <div id="transcript-area">
            <div id="transcript-header">
                <h3>Transcript:</h3>
                <div id="action-buttons">
                    <button id="viewStudyButton" class="analyze-button" onclick="openStudyNotesModal()" disabled>View Study Notes</button>
                    <button id="semanticSearchButton" class="search-button" onclick="openSemanticSearchModal()" disabled>Semantic Search</button>
                    <button id="analyzeButton" class="analyze-button" onclick="analyzeEmotion()">Analyze Emotion</button>
                </div>
            </div>
            <p id="transcript-content"></p>
        </div>
        
    </div>

    <div class="modal fade" id="emotionModal" tabindex="-1" aria-labelledby="emotionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content emotion-modal-content">
                <div class="modal-header emotion-modal-header">
                    <h5 class="modal-title emotion-modal-title" id="emotionModalLabel">Emotion Analysis Chart</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <p class="fs-5 mb-1">Overall Emotion (Most Frequent):</p>
                        <p id="overallEmotionResult" class="fs-3 fw-bold text-uppercase" style="color:#00ff73;">Loading...</p>
                    </div>
                    <hr style="border-color:#333;">
                    <h6 class="text-center text-secondary mb-3">Emotion Over Time</h6>
                    <div id="emotionChartContainer">
                        <canvas id="emotionChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer emotion-modal-footer">
                    <button type="button" class="btn analyze-button" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="semanticSearchModal" tabindex="-1" aria-labelledby="semanticSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content search-modal-content">
                <div class="modal-header search-modal-header">
                    <h5 class="modal-title search-modal-title" id="semanticSearchModalLabel">Semantic Search</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <p>Enter a keyword or phrase to find the most relevant moment in the transcript:</p>
                    <div class="input-group mb-3">
                        <input type="text" id="searchInput" class="form-control" placeholder="E.g., 'machine learning' or 'project completion'" aria-label="Search keyword" style="background-color: #2a2a2a; color: white; border: 1px solid #444;">
                        <button class="btn search-button" type="button" id="executeSearchButton" onclick="executeSemanticSearch()">
                            <span id="searchSpinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display:none;"></span>
                            Search
                        </button>
                    </div>
                    <div id="searchResultsArea">
                        <small class="text-secondary">Click on a result to jump the video to that moment.</small>
                    </div>
                </div>
                <div class="modal-footer search-modal-footer">
                    <button type="button" class="btn search-button" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="studyModal" tabindex="-1" aria-labelledby="studyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content emotion-modal-content">
                <div class="modal-header emotion-modal-header">
                    <h5 class="modal-title emotion-modal-title" id="studyModalLabel">Study Notes & Multimodal Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <div id="studyNotesArea">
                        <h5 class="text-secondary">Summary (Visual & Audio-Aware)</h5>
                        <p id="studySummaryResult" class="fs-6 text-white border-bottom border-secondary pb-3">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Summary loading... Please click 'Run Study Mode' first.
                        </p>

                        <h5 class="mt-4 text-secondary">Key Topics / Tags</h5>
                        <div id="studyTagsResult" class="d-flex flex-wrap gap-2">
                            </div>
                        
                        <div id="save-feedback" class="mt-4 text-center">
                            </div>
                    </div>

                    <div id="cognitiveMapArea" style="display: none; padding: 10px; border-radius: 5px; background-color: rgba(255, 255, 255, 0.05); min-height: 400px;">
                        <h5 class="text-info mb-3">Generated Cognitive Map</h5>
                        <div id="mapVisualization">
                            <p class="text-secondary">Click 'Cognitive Map' to generate the knowledge graph.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer emotion-modal-footer">
                    <button id="cognitiveMapButton" class="btn map-button" onclick="openCognitiveMap()" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-diagram-3" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M11.5 6a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5m-.5 2h-1A.5.5 0 0 0 10 8.5v3.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5V8.5A.5.5 0 0 0 7 8H6a.5.5 0 0 0-.5.5v2.5h-1V9a.5.5 0 0 0-1 0v2.5a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5V10.5a.5.5 0 0 1 1 0v.5h1v-2h-1A.5.5 0 0 0 8 8.5v1h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-2a.5.5 0 0 0-.5.5v1h-1a.5.5 0 0 0-.5-.5v-1a.5.5 0 0 0-.5-.5h-2A.5.5 0 0 0 0 8.5v3.5a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5V8.5a.5.5 0 0 0-.5-.5h-2a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1v-1a.5.5 0 0 0-.5-.5H13a.5.5 0 0 0-.5.5v2.5h-1V8.5a.5.5 0 0 0-.5-.5H11.5zM2.5 6a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5m9 6a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5m-9 0a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/>
                        </svg>
                        Cognitive Map
                    </button>
                    <button id="saveNotesButton" class="btn download-button" onclick="saveStudyNotes()" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                            <path d="M.5 1a.5.5 0 0 0 0 1h.5v12a.5.5 0 0 0 1 0V2h12a.5.5 0 0 0 0-1H.5z"/>
                            <path d="M14.5 3a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h13zM14 4H3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1z"/>
                        </svg>
                        Save Notes
                    </button>
                    <button type="button" class="btn analyze-button" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" xintegrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" xintegrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

    <script>
        // Global variables
        let transcriptionSegments = [];
        let currentHighlightedSegment = null;
        let emotionChartInstance = null;
        let srtDownloadUrl = ''; // Note: SRT download was removed in the app.py but kept here just in case.
        let studyNotesCache = null; // NEW: Cache for study notes
        let saveNotesButton = null; // Reference to the save button
        let cognitiveMapButton = null; // NEW: Reference to the map button
        let saveFeedback = null; // Reference to the feedback div
        let semanticSearchButton = null; // Reference to the semantic search button

        // EMOTION MAPS (omitted for brevity)
        const EMOTION_MAP = {
            'LOVE': 5,
            'JOY': 4,
            'SURPRISE': 3,
            'NEUTRAL': 2,
            'SADNESS': 1,
            'FEAR': 0,
            'ANGER': -1
        };
        const EMOTION_LABELS = {
            '-1': 'Anger',
            '0': 'Fear',
            '1': 'Sadness',
            '2': 'Neutral',
            '3': 'Surprise',
            '4': 'Joy',
            '5': 'Love'
        };
        const EMOTION_COLORS = {
            'LOVE': '#ff69b4',
            'JOY': '#ffa500',
            'SURPRISE': '#ffff00',
            'NEUTRAL': '#ccc',
            'SADNESS': '#4682b4',
            'FEAR': '#800080',
            'ANGER': '#ff0000'
        };


        function formatTime(seconds) {
            const totalSeconds = Math.floor(seconds);
            const minutes = Math.floor(totalSeconds / 60);
            const remainingSeconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(remainingSeconds)}`; 
        }

        /**
         * Toggles the UI state (loading, disabled buttons).
         */
        function toggleUI(loading, processing) {
            document.getElementById('loading-indicator').style.display = loading ? 'block' : 'none';
            
            const fileSelected = !!document.getElementById('audioFileInput').files[0];
            
            const captionButton = document.getElementById('captionModeButton');
            const studyButton = document.getElementById('studyModeButton');
            const analyzeButton = document.getElementById('analyzeButton');
            const viewStudyButton = document.getElementById('viewStudyButton');
            const searchButton = document.getElementById('semanticSearchButton'); 

            // Caption Mode button only requires file to be selected
            captionButton.disabled = processing || !fileSelected;

            // Study Mode button is enabled once file is selected AND not currently processing
            studyButton.disabled = processing || !fileSelected || (transcriptionSegments.length === 0 && !studyNotesCache);

            // Action buttons require transcription to be complete
            const transcriptionDone = transcriptionSegments.length > 0;
            analyzeButton.disabled = processing || !transcriptionDone;
            viewStudyButton.disabled = processing || !studyNotesCache;
            searchButton.disabled = processing || !transcriptionDone; 

            // Save and Cognitive Map buttons inside modal
            if (saveNotesButton) {
                 saveNotesButton.disabled = processing || !studyNotesCache;
            }
            if (cognitiveMapButton) { // NEW
                 cognitiveMapButton.disabled = processing || !studyNotesCache;
            }


            // Hide results while processing/resetting
            if (loading && processing) {
                document.getElementById('media-player-area').style.opacity = '0';
                document.getElementById('media-player-area').style.display = 'none';
                document.getElementById('transcript-area').style.opacity = '0';
                document.getElementById('transcript-area').style.display = 'none';
                document.getElementById('file-error-message').style.display = 'none';
                
                const player = document.getElementById('media-player');
                player.src = '';
                Array.from(player.querySelectorAll('track')).forEach(track => track.remove());
                
                // Clear state
                transcriptionSegments = [];
                currentHighlightedSegment = null;
                studyNotesCache = null; // Clear cache
                
                // Re-disable action buttons as transcription is now empty
                analyzeButton.disabled = true;
                viewStudyButton.disabled = true; 
                searchButton.disabled = true; 
            }

            // After successful initial processing (in final block of uploadAndProcessAudio)
            if (!loading && !processing && transcriptionDone) {
                 studyButton.disabled = false;
            }
        }
        
        function syncTranscript() {
            // ... (existing logic for transcript synchronization)
            const player = document.getElementById('media-player');
            const currentTime = player.currentTime;
            
            for (let i = 0; i < transcriptionSegments.length; i++) {
                const segment = transcriptionSegments[i];
                if (currentTime >= segment.start && currentTime < segment.end) {
                    const segmentElement = document.getElementById(`segment-${i}`);
                    
                    if (currentHighlightedSegment !== segmentElement) {
                        if (currentHighlightedSegment) {
                            currentHighlightedSegment.classList.remove('highlighted-segment');
                            const prevIndex = parseInt(currentHighlightedSegment.id.split('-')[1]);
                            const prevSegment = transcriptionSegments[prevIndex];
                            if (prevSegment && prevSegment.emotion) {
                                currentHighlightedSegment.classList.add(`emotion-${prevSegment.emotion.toUpperCase()}`);
                            }
                        }
                        
                        segmentElement.classList.add('highlighted-segment');
                        const currentEmotion = segment.emotion;
                        segmentElement.classList.remove(`emotion-${currentEmotion.toUpperCase()}`);
                        
                        currentHighlightedSegment = segmentElement;
                        segmentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return; 
                }
            }

            if (currentHighlightedSegment && (player.paused || currentTime >= player.duration)) {
                currentHighlightedSegment.classList.remove('highlighted-segment');
                const segmentIndex = parseInt(currentHighlightedSegment.id.split('-')[1]);
                const segment = transcriptionSegments[segmentIndex];
                if (segment && segment.emotion) {
                    currentHighlightedSegment.classList.add(`emotion-${segment.emotion.toUpperCase()}`);
                }
                currentHighlightedSegment = null;
            }
        }

        function jumpToTime(timeInSeconds) {
            const player = document.getElementById('media-player');
            if (player && timeInSeconds !== undefined && timeInSeconds !== null) {
                player.currentTime = timeInSeconds;
                player.play();
                
                // For the transcript view to jump to the correct place immediately
                const segmentToHighlight = transcriptionSegments.find(segment => 
                    timeInSeconds >= segment.start && timeInSeconds < segment.end
                );
                
                if (segmentToHighlight) {
                    const index = transcriptionSegments.indexOf(segmentToHighlight);
                    const segmentElement = document.getElementById(`segment-${index}`);
                    if (segmentElement) {
                        // Manually trigger highlight and scroll if the video update hasn't caught up yet
                        if (currentHighlightedSegment) {
                            currentHighlightedSegment.classList.remove('highlighted-segment');
                            const prevIndex = parseInt(currentHighlightedSegment.id.split('-')[1]);
                            const prevSegment = transcriptionSegments[prevIndex];
                            if (prevSegment && prevSegment.emotion) {
                                currentHighlightedSegment.classList.add(`emotion-${prevSegment.emotion.toUpperCase()}`);
                            }
                        }
                        segmentElement.classList.add('highlighted-segment');
                        const currentEmotion = segmentToHighlight.emotion;
                        segmentElement.classList.remove(`emotion-${currentEmotion.toUpperCase()}`);
                        currentHighlightedSegment = segmentElement;
                        segmentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        }
        
        // Overloaded jumpToTime for transcript segment click compatibility
        function jumpToSegment(segmentIndex) {
            const segment = transcriptionSegments[segmentIndex];
            if (segment) {
                jumpToTime(segment.start);
            }
        }


        // --- NEW: Semantic Search Functions (Existing) ---

        /**
         * Opens the semantic search modal.
         */
        function openSemanticSearchModal() {
            if (transcriptionSegments.length === 0) {
                 // Should be disabled but as a fallback
                alert('Please run Caption Mode first to generate the transcript before searching.');
                return;
            }
            // Clear previous results and input
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResultsArea').innerHTML = '<small class="text-secondary">Click on a result to jump the video to that moment.</small>';
            
            const searchModal = new bootstrap.Modal(document.getElementById('semanticSearchModal'));
            searchModal.show();
        }

        /**
         * Executes the semantic search logic (simulated with a fetch to backend).
         */
        async function executeSemanticSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const resultsArea = document.getElementById('searchResultsArea');
            const searchButton = document.getElementById('executeSearchButton');
            const searchSpinner = document.getElementById('searchSpinner');

            if (query.length < 3) {
                resultsArea.innerHTML = '<p class="text-danger mt-3">Please enter a keyword or phrase of at least 3 characters.</p>';
                return;
            }
            
            // Set loading state
            searchButton.disabled = true;
            searchSpinner.style.display = 'inline';
            resultsArea.innerHTML = '<p class="text-secondary mt-3"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Searching for relevance...</p>';

            try {
                // Fetch the search results from the backend
                const response = await fetch('/semantic-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Server returned an error.');
                }
                
                // Display results
                displaySearchResults(data.results, resultsArea); 

            } catch (e) {
                console.error('Semantic Search failed:', e);
                resultsArea.innerHTML = `<p class="text-danger mt-3">Search Error: ${e.message}</p>`;

            } finally {
                // Reset loading state
                searchButton.disabled = false;
                searchSpinner.style.display = 'none';
            }
        }
        
        /**
         * Populates the search results area in the modal.
         */
        function displaySearchResults(results, resultsArea) {
             resultsArea.innerHTML = '';
             
             if (results.length === 0) {
                 resultsArea.innerHTML = '<p class="text-info mt-3">No relevant segments found for your query.</p>';
                 return;
             }
             
             resultsArea.innerHTML = '<small class="text-secondary">Click on a result to jump the video to that moment.</small><hr style="border-color:#333;">';

             results.forEach(result => {
                 const resultElement = document.createElement('div');
                 resultElement.className = 'search-result-item';
                 
                 // Display timestamp and segment text
                 const timestamp = formatTime(result.start_time);
                 const speakerLabel = result.speaker ? `<strong>${result.speaker}: </strong>` : '';
                 const relevanceScore = result.relevance ? ` (${(result.relevance * 100).toFixed(1)}% Match)` : '';
                 
                 resultElement.innerHTML = `<span class="result-timestamp">[${timestamp}]</span> ${speakerLabel}${result.text}${relevanceScore}`;
                 
                 // Add click listener to jump video
                 resultElement.onclick = () => {
                     jumpToTime(result.start_time);
                     // Optionally close modal
                     const searchModal = bootstrap.Modal.getInstance(document.getElementById('semanticSearchModal'));
                     searchModal.hide();
                 };
                 
                 resultsArea.appendChild(resultElement);
             });
        }

        // --- END: Semantic Search Functions ---


        // --- NEW: Study Mode Functions (Existing) ---

        /**
         * Triggers the study mode processing on the backend.
         */
        async function processStudyMode() {
            if (transcriptionSegments.length === 0) {
                 // Trigger the Study Modal to show the error
                const studyModal = new bootstrap.Modal(document.getElementById('studyModal'));
                studyModal.show();
                document.getElementById('studySummaryResult').innerHTML = '<span class="text-danger">Error: Please run "Caption Mode" first to generate the transcript.</span>';
                document.getElementById('studyTagsResult').innerHTML = '';
                if (saveNotesButton) saveNotesButton.disabled = true;
                if (cognitiveMapButton) cognitiveMapButton.disabled = true; // NEW
                return;
            }

            // Show loading feedback in the modal
            const studyModal = new bootstrap.Modal(document.getElementById('studyModal'));
            studyModal.show();
            document.getElementById('studySummaryResult').innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Analyzing video visuals and transcript...';
            document.getElementById('studyTagsResult').innerHTML = '';
            document.getElementById('studyModeButton').disabled = true;
            if (saveNotesButton) saveNotesButton.disabled = true;
            if (cognitiveMapButton) cognitiveMapButton.disabled = true; // NEW
            if (saveFeedback) saveFeedback.innerHTML = '';
            
            // Set default view
            openStudyNotesModal(false); // Open without triggering the modal again

            try {
                const response = await fetch('/process-study-mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Server returned an error.');
                }
                
                studyNotesCache = data.study_notes;
                displayStudyNotes(studyNotesCache);
                document.getElementById('viewStudyButton').disabled = false;
                if (saveNotesButton) saveNotesButton.disabled = false;
                if (cognitiveMapButton) cognitiveMapButton.disabled = false; // NEW


            } catch (e) {
                console.error('Study Mode failed:', e);
                document.getElementById('studySummaryResult').innerHTML = `<span class="text-danger">Study Mode Error: ${e.message}</span>`;
                document.getElementById('studyTagsResult').innerHTML = '<span class="text-danger">Failed to generate tags.</span>';
                if (saveNotesButton) saveNotesButton.disabled = true;
                if (cognitiveMapButton) cognitiveMapButton.disabled = true; // NEW

            } finally {
                // Re-enable the Study Mode button if processing failed or finished
                if (transcriptionSegments.length > 0) {
                     document.getElementById('studyModeButton').disabled = false;
                }
            }
        }
        
        /**
         * Opens the study notes modal and populates it.
         */
        function openStudyNotesModal(showModal = true) {
             if (!studyNotesCache) {
                 document.getElementById('studySummaryResult').innerHTML = '<span class="text-danger">No study notes found. Please click "Study Mode" first.</span>';
                 document.getElementById('studyTagsResult').innerHTML = '';
             } else {
                 displayStudyNotes(studyNotesCache);
             }
             if (saveFeedback) saveFeedback.innerHTML = '';
             
             // NEW: Ensure default view is summary/tags
             document.getElementById('studyNotesArea').style.display = 'block';
             document.getElementById('cognitiveMapArea').style.display = 'none';

             if (showModal) {
                 const studyModal = new bootstrap.Modal(document.getElementById('studyModal'));
                 studyModal.show();
             }
        }

        /**
         * Populates the study notes modal with the results.
         */
        function displayStudyNotes(notes) {
            document.getElementById('studySummaryResult').innerText = notes.summary;
            
            const tagsContainer = document.getElementById('studyTagsResult');
            tagsContainer.innerHTML = '';
            notes.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerText = tag;
                tagsContainer.appendChild(tagElement);
            });
            
            // Enable buttons after notes are successfully loaded
            if (saveNotesButton) saveNotesButton.disabled = false;
            if (cognitiveMapButton) cognitiveMapButton.disabled = false; // NEW
        }
        
        /**
         * Calls the API to save the generated study notes to the database.
         */
        async function saveStudyNotes() {
             if (!studyNotesCache) {
                 if (saveFeedback) saveFeedback.innerHTML = '<div class="alert alert-danger" role="alert">Error: No notes to save. Run Study Mode first.</div>';
                 return;
             }

             if (saveNotesButton) {
                 saveNotesButton.disabled = true;
                 saveNotesButton.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving & Generating Title...`;
             }
             if (saveFeedback) saveFeedback.innerHTML = '';

             try {
                const response = await fetch('/save-study-notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Server returned an error.');
                }
                
                // Success feedback
                if (saveFeedback) {
                    saveFeedback.innerHTML = `<div class="alert alert-success" role="alert">
                        <strong>Saved!</strong> Title: "${data.generated_title}" (ID: ${data.note_id})
                    </div>`;
                }


             } catch (e) {
                console.error('Save Notes failed:', e);
                if (saveFeedback) {
                    saveFeedback.innerHTML = `<div class="alert alert-danger" role="alert">
                        Failed to save notes: ${e.message}
                    </div>`;
                }

             } finally {
                if (saveNotesButton) {
                    saveNotesButton.disabled = false;
                    saveNotesButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-save" viewBox="0 0 16 16">
                            <path d="M.5 1a.5.5 0 0 0 0 1h.5v12a.5.5 0 0 0 1 0V2h12a.5.5 0 0 0 0-1H.5z"/>
                            <path d="M14.5 3a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h13zM14 4H3a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1z"/>
                        </svg>
                        Save Notes`;
                }
             }
        }
        
        // --- NEW: Cognitive Map Functions ---

        /**
         * Switches the modal view to the map and fetches map data.
         */
        async function openCognitiveMap() {
            // 1. Switch view
            document.getElementById('studyNotesArea').style.display = 'none';
            
            const mapArea = document.getElementById('cognitiveMapArea');
            mapArea.style.display = 'block';
            
            const mapVisualization = document.getElementById('mapVisualization');
            
            // 2. Set loading state
            cognitiveMapButton.disabled = true;
            mapVisualization.innerHTML = '<p class="text-info"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generating cognitive map from study notes...</p>';

            try {
                // 3. Call backend API
                const response = await fetch('/get-cognitive-map', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Server returned an error.');
                }
                
                // 4. Display the map
                displayCognitiveMap(data.map_data, mapVisualization);

            } catch (e) {
                console.error('Cognitive Map generation failed:', e);
                mapVisualization.innerHTML = `<p class="text-danger mt-3">Map Generation Error: ${e.message}</p>`;

            } finally {
                // Re-enable the map button on completion
                cognitiveMapButton.disabled = false;
            }
        }
        
        /**
         * Renders the cognitive map data (nodes and edges) as a simple HTML list.
         * Assumes mapData has {nodes: [{id, label}], edges: [{source, target, relationship}]}.
         */
        function displayCognitiveMap(mapData, container) {
            if (!mapData || !mapData.nodes || !mapData.edges) {
                container.innerHTML = '<p class="text-warning">The map generator returned an invalid structure (missing nodes or edges).</p>';
                return;
            }
            
            let html = `<div style="max-height: 400px; overflow-y: auto;">`;
            
            // Nodes
            html += `<h6 class="text-light mt-3">Nodes (Key Concepts):</h6><div class="d-flex flex-wrap gap-2 mb-4">`;
            mapData.nodes.forEach(node => {
                const nodeText = node.label || node.id || 'N/A';
                html += `<span class="tag" style="background-color: #8a2be2; border-color: #8a2be2;">${nodeText}</span>`;
            });
            html += `</div>`;
            
            // Edges
            html += `<h6 class="text-light mt-4">Edges (Relationships):</h6><ul class="list-unstyled">`;
            mapData.edges.forEach(edge => {
                html += `<li style="margin-bottom: 5px;"><span class="text-warning">${edge.source || '?'}</span> 
                         <span class="text-secondary">--(${edge.relationship || 'relates to'})--></span> 
                         <span class="text-success">${edge.target || '?'}</span></li>`;
            });
            html += `</ul></div>`;

            container.innerHTML = html;
        }

        // --- END: Cognitive Map Functions ---

        async function analyzeEmotion() {
            // ... (existing logic for emotion analysis)
            if (transcriptionSegments.length === 0) {
                document.getElementById('overallEmotionResult').innerHTML = '<span class="text-danger">No Transcript Data</span>';
                const emotionModal = new bootstrap.Modal(document.getElementById('emotionModal'));
                emotionModal.show();
                return;
            }
            // ... (rest of analyzeEmotion logic unchanged) ...
            document.getElementById('overallEmotionResult').innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Analyzing...';
            const emotionModal = new bootstrap.Modal(document.getElementById('emotionModal'));
            emotionModal.show();
            
            try {
                const response = await fetch('/get-emotion-chart-data', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Server returned an error.');
                }
                
                const overallEmotion = data.overall_emotion || "Neutral";
                const segments = data.segments || [];

                // 1. Prepare Chart Data (omitted for brevity)
                const chartDataPoints = [];
                const chartLabels = [];
                const chartColors = [];
                
                segments.forEach(segment => {
                    const emotionKey = (segment.emotion || 'NEUTRAL').toUpperCase();
                    const emotionValue = EMOTION_MAP[emotionKey] || EMOTION_MAP['NEUTRAL'];
                    const timePoint = segment.start + (segment.end - segment.start) / 2; 

                    chartDataPoints.push({ x: timePoint, y: emotionValue });
                    chartLabels.push(formatTime(segment.start));
                    chartColors.push(EMOTION_COLORS[emotionKey]);
                });
                
                // 2. Update Overall Emotion Text
                document.getElementById('overallEmotionResult').innerHTML = overallEmotion;
                document.getElementById('overallEmotionResult').style.color = EMOTION_COLORS[overallEmotion.toUpperCase()] || '#00ff73';

                // 3. Render Chart (omitted for brevity)
                if (emotionChartInstance) { emotionChartInstance.destroy(); }

                const ctx = document.getElementById('emotionChart').getContext('2d');
                emotionChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Segment Emotion',
                            data: chartDataPoints,
                            fill: false,
                            tension: 0.1,
                            borderColor: '#00ff73',
                            pointBackgroundColor: chartColors,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointStyle: 'circle'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                callbacks: { 
                                    title: (context) => formatTime(context[0].parsed.x),
                                    label: (context) => `Emotion: ${EMOTION_LABELS[String(context.parsed.y)]}`
                                } 
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Time (Seconds)', color: '#ccc' },
                                ticks: { callback: function(value, index, ticks) { return formatTime(value); }, color: '#999' }
                            },
                            y: {
                                min: -1.5, max: 5.5,
                                title: { display: true, text: 'Emotion', color: '#ccc' },
                                ticks: { callback: function(value, index, ticks) { return EMOTION_LABELS[String(value)] || ''; }, stepSize: 1, color: '#999' },
                                grid: { color: '#333' }
                            }
                        }
                    }
                });


            } catch (e) {
                console.error('Emotion analysis failed:', e);
                document.getElementById('overallEmotionResult').innerHTML = `<span class="text-danger">Error: ${e.message}</span>`;
            }
        }

        /**
         * Handles file upload and initial transcription/caption processing (Caption Mode).
         */
        async function uploadAndProcessAudio() {
            const fileInput = document.getElementById('audioFileInput');
            const file = fileInput.files[0];

            if (!file) {
                document.getElementById('file-error-message').style.display = 'block';
                return;
            }

            toggleUI(true, true); // Start loading state
            
            const formData = new FormData();
            formData.append('audioFile', file);

            try {
                const response = await fetch('/upload-audio', {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Server returned an error.');
                }

                // 1. Store and prepare data
                const transcriptData = data.transcript_data;
                transcriptionSegments = transcriptData.segments; 
                const mediaUrl = data.media_url;
                const vttUrl = data.vtt_url;

                // 2. Setup Media Player
                const player = document.getElementById('media-player');
                player.src = mediaUrl;
                player.load();
                player.removeEventListener('timeupdate', syncTranscript);
                player.addEventListener('timeupdate', syncTranscript);

                // Add the WebVTT track
                const trackElement = document.createElement('track');
                trackElement.kind = 'subtitles';
                trackElement.label = 'English';
                trackElement.srclang = 'en';
                trackElement.src = vttUrl;
                trackElement.default = true;
                
                // Clear existing tracks before appending
                Array.from(player.querySelectorAll('track')).forEach(track => track.remove());
                player.appendChild(trackElement);
                
                // 3. Construct Segmented Transcript
                const transcriptContentElement = document.getElementById('transcript-content');
                transcriptContentElement.innerHTML = '';

                let transcriptHTML = '';
                transcriptionSegments.forEach((segment, index) => {
                    const speakerLabel = segment.speaker ? `${segment.speaker}: ` : '';
                    const timestamp = formatTime(segment.start); 
                    const emotionClass = segment.emotion ? `emotion-${segment.emotion.toUpperCase()}` : 'emotion-NEUTRAL';

                    transcriptHTML += `<span 
                        id="segment-${index}" 
                        class="time-segment ${emotionClass}" 
                        data-start="${segment.start}" 
                        data-end="${segment.end}"
                        onclick="jumpToSegment(${index})"
                    >
                        <span class="timestamp">[${timestamp}]</span>
                        <strong>${speakerLabel}</strong>${segment.text}
                    </span>`;
                });
                transcriptContentElement.innerHTML = transcriptHTML;


                // 4. Reveal results
                setTimeout(() => {
                    document.getElementById('media-player-area').style.display = 'block';
                    document.getElementById('transcript-area').style.display = 'block';
                    
                    document.getElementById('media-player-area').style.opacity = '1';
                    document.getElementById('transcript-area').style.opacity = '1';

                }, 50);

            } catch (e) {
                console.error('Processing failed:', e);
                const errorMessage = (e.message.includes("OpenAI API Error")) ? e.message : `An error occurred during transcription: ${e.message}`;
                 document.getElementById('studySummaryResult').innerHTML = `<span class="text-danger">Caption Mode Error: ${errorMessage}</span>`;
                const studyModal = new bootstrap.Modal(document.getElementById('studyModal'));
                studyModal.show();

            } finally {
                // 5. Hide loading state and re-enable buttons
                toggleUI(false, false);
            }
        }

        // Initialize and setup event listeners on page load
        document.addEventListener('DOMContentLoaded', () => {
            saveNotesButton = document.getElementById('saveNotesButton');
            cognitiveMapButton = document.getElementById('cognitiveMapButton'); // NEW
            saveFeedback = document.getElementById('save-feedback');
            semanticSearchButton = document.getElementById('semanticSearchButton'); // NEW
            const fileInput = document.getElementById('audioFileInput');
            
            // Listener to enable the buttons when a file is selected
            fileInput.addEventListener('change', () => {
                const errorMessage = document.getElementById('file-error-message');
                if (fileInput.files.length > 0) {
                    document.getElementById('captionModeButton').disabled = false;
                    document.getElementById('studyModeButton').disabled = false;
                    errorMessage.style.display = 'none';
                } else {
                    document.getElementById('captionModeButton').disabled = true;
                    document.getElementById('studyModeButton').disabled = true;
                }
            });
            
            // Set initial state
            toggleUI(false, false);
            document.getElementById('captionModeButton').innerText = 'Caption Mode'; 
            document.getElementById('studyModeButton').innerText = 'Study Mode';
        });


      

    </script>

</body>
</html>
